name: Deploy to Staging

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: haddar-nextflix_cicd-repo
  IMAGE_TAG: staging-pr-${{ github.event.pull_request.number }}-${{ github.sha }}

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        
      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:staging-latest
          
      - name: Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:staging-latest
          
      - name: Deploy to Staging EC2
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          mkdir -p ~/.ssh
          echo "$STAGING_SSH_KEY" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key
          ssh-keyscan -H $STAGING_HOST >> ~/.ssh/known_hosts
          
          ssh -T -i ~/.ssh/staging_key ubuntu@$STAGING_HOST << 'ENDSSH'
            aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}
            
            docker stop haddar-nextflix-staging || true
            docker rm haddar-nextflix-staging || true
            docker pull ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            
            docker run -d \
              --name haddar-nextflix-staging \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -m 768m \
              --memory-swap 768m \
              ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            
            docker image prune -af --filter "until=48h"
          ENDSSH
          
      - name: Health Check
        run: |
          sleep 15
          for i in {1..30}; do
            if curl -f http://${{ secrets.STAGING_HOST }}:3000/ > /dev/null 2>&1; then
              echo "✅ Staging deployment successful!"
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          exit 1
          
      - name: Telegram Notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_EMOJI="✅"
            STATUS="SUCCESS"
          else
            STATUS_EMOJI="❌"
            STATUS="FAILED"
          fi
          
          MESSAGE="${STATUS_EMOJI} *Staging Deployment ${STATUS}*%0A%0A"
          MESSAGE="${MESSAGE}*Environment:* Staging (t3.micro)%0A"
          MESSAGE="${MESSAGE}*PR:* #${{ github.event.pull_request.number }}%0A"
          MESSAGE="${MESSAGE}*Author:* ${{ github.actor }}%0A"
          MESSAGE="${MESSAGE}*Branch:* ${{ github.head_ref }}%0A"
          MESSAGE="${MESSAGE}*Commit:* $(echo ${{ github.sha }} | cut -c1-7)%0A"
          MESSAGE="${MESSAGE}*Status:* ${{ job.status }}%0A"
          MESSAGE="${MESSAGE}*URL:* http://${{ secrets.STAGING_HOST }}:3000"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown"
